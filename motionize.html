<!doctype html>
<html lang="en">
    <head>
        <title>Motionize events map  </title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">

        <link href="https://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,600,700" rel="stylesheet" type="text/css">
        <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">
        <link href="http://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/0.0.11/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
        <link href="../stylesheets/motionize-marker-communication.css" rel="stylesheet" type="text/css">
        <link href="../stylesheets/simple-slider.css" rel="stylesheet" type="text/css">

        <script type='text/javascript' src='http://maps.google.com/maps/api/js?sensor=false'></script>
        <script src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclustererplus/src/markerclusterer.js" type="text/javascript"></script>
        <script type='text/javascript' src='/_ah/channel/jsapi'></script>
        <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js'></script>
        <script type='text/javascript' src='http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js'></script>
        <script type='text/javascript' src='http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.5.0/moment.min.js'></script>
        <script type='text/javascript' src='../js/bootstrap-datetimepicker.js'></script>
        <script type='text/javascript' src='../js/simple-slider.js'></script>

    </head>
    <body>
        <div id="wrapper">
            <form class="form-horizontal" name="MotionizeMapForm" method="get" id="AHRlWrpkLb8g1StYdI3ZR-Uk5xn_WK4mRe-OyGUjwaA005tKKAezqCMPKwjeotreBQ3pm7o0XV1SWR-w-5Ci0J_kJ6eaSeOlbO2ydoFnDhTbnYzFNntxFz8">
                <fieldset>

                <!-- Form Name -->
                <legend>Event Filtering <span id="countedmatches"></span></legend>

                <div class="form-group" style="margin: 0 -20px; width: 350px;">
                    <div class="well" style="height:102px;">
                       <div class='col-fullwidth'>
                            <div class='input-group date' id='datetimepicker_from'>
                                <input type='text' class='form-control' id='datetimepicker_from_input' />
                                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                        <div class='col-fullwidth'>
                            <div class='input-group date' id='datetimepicker_to'>
                                <input type='text' class='form-control' id='datetimepicker_to_input' />
                                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Limit results -->
                <div class="form-group limit-container">
                  <label class="col-md-4 control-label" for="limit">Limit</label>
                  <div class="col-md-8 limit-wrapper"></div>
                </div>
                <div class="form-group">
                  <div class="col-md-12" id="limit-range">
                      <input id='limit' name='limit' type='text' class='form-control input-md' value='100'
                          data-slider="true" data-slider-values="100,200,400,800,1600,3200"
                          data-slider-snap="true" data-slider-equal-steps="true" data-slider-highlight="true">
                  </div>
                </div>

                <!-- Multiple Checkboxes -->
                <div class="form-group">
                  <label class="col-md-4 control-label">Event type</label>
                  <div class="col-md-8">
                    <div class="checkbox">
                      <label for="eventtype-all">
                        <input type="checkbox" name="eventtype" id="eventtype-all" value="All" checked>
                        <strong>All events</strong>
                      </label>
                    </div>

                  

                    <div class="checkbox">
                      <label for="eventtype-1">
                        <img src="../images/map/motionize-marker-1hour.png" class='vlegend'>
                        <input type="checkbox" name="eventtype" id="eventtype-1" value="1HOUR">
                        1hour
                      </label>
                    </div>

                  

                    <div class="checkbox">
                      <label for="eventtype-2">
                        <img src="../images/map/motionize-marker-1km.png" class='vlegend'>
                        <input type="checkbox" name="eventtype" id="eventtype-2" value="1KM">
                        1km
                      </label>
                    </div>

                  

                    <div class="checkbox">
                      <label for="eventtype-3">
                        <img src="../images/map/motionize-marker-approaching.png" class='vlegend'>
                        <input type="checkbox" name="eventtype" id="eventtype-3" value="APPROACHING">
                        Approaching
                      </label>
                    </div>

                  

                    <div class="checkbox">
                      <label for="eventtype-4">
                        <img src="../images/map/motionize-marker-driving.png" class='vlegend'>
                        <input type="checkbox" name="eventtype" id="eventtype-4" value="DRIVING">
                        Driving
                      </label>
                    </div>

                  

                    <div class="checkbox">
                      <label for="eventtype-5">
                        <img src="../images/map/motionize-marker-movingaway.png" class='vlegend'>
                        <input type="checkbox" name="eventtype" id="eventtype-5" value="MOVINGAWAY">
                        Movingaway
                      </label>
                    </div>

                  

                    <div class="checkbox">
                      <label for="eventtype-6">
                        <img src="../images/map/motionize-marker-parking.png" class='vlegend'>
                        <input type="checkbox" name="eventtype" id="eventtype-6" value="PARKING">
                        Parking
                      </label>
                    </div>

                  

                    <div class="checkbox">
                      <label for="eventtype-7">
                        <img src="../images/map/motionize-marker-close_parking.png" class='vlegend'>
                        <input type="checkbox" name="eventtype" id="eventtype-7" value="CLOSE_PARKING">
                        Close_parking
                      </label>
                    </div>

                  

                    <div class="checkbox">
                      <label for="eventtype-8">
                        <img src="../images/map/motionize-marker-ready.png" class='vlegend'>
                        <input type="checkbox" name="eventtype" id="eventtype-8" value="READY">
                        Ready
                      </label>
                    </div>

                  

                    <div class="checkbox">
                      <label for="eventtype-9">
                        <img src="../images/map/motionize-marker-drivingloc.png" class='vlegend'>
                        <input type="checkbox" name="eventtype" id="eventtype-9" value="DrivingLoc">
                        Drivingloc
                      </label>
                    </div>

                  

                  </div>
                </div>

                <!-- Accuracy and device targeting -->
                <div class="form-group">
                  <label class="col-md-4 control-label">Accuracy</label>
                  <div class="col-md-8">
                    <label class="checkbox-inline" for="accuracy">
                      <input type="checkbox" name="accuracy" id="accuracy" value="on" checked>
                      Display on map
                    </label>
                  </div>
                </div>

                <!-- Text input-->
                <div class="form-group">
                  <label class="col-md-4 control-label">Company</label>
                  <div class="col-md-8">
                      <label class="inline-align">
                          
                              <input id="companyname" name="companyname" type="text" placeholder="Company" class="form-control input-md">
                              <!--<input id="companyname" name="companyname" type="text" placeholder="Company" class="form-control input-md">-->
                          
                      </label>
                  </div>
                </div>

                <!-- Prepended checkbox -->
                <div class="form-group">
                  <label class="col-md-4 control-label" for="deviceid">Device Id</label>
                  <div class="col-md-8">
                    <div class="input-group">
                      <span class="input-group-addon">     
                          <input type="checkbox">
                      </span>
                      <input id="deviceid" name="deviceid" class="form-control" type="text" placeholder="All devices (default)">
                    </div>
                    
                  </div>
                </div>

                <!-- Button -->
                <div class="form-group">
                  <label class="col-md-4 control-label" for="submit"></label>
                  <div class="col-md-4">
                    <button id="submit" name="submit" class="btn btn-info">Show events</button>
                  </div>
                </div>

                </fieldset>
            </form>
        </div>

        <div id="logging"><a href="http://map.motionize.com/_ah/logout?continue=https://www.google.com/accounts/Logout%3Fcontinue%3Dhttps://appengine.google.com/_ah/logout%253Fcontinue%253Dhttp://map.motionize.com/%26service%3Dah">Logout</a></div>

        <div id="mapbg"></div>

        <script type="text/javascript">

            /* visual local time formatting utility */
            var Utils = (function(momentjs){

                var config = {
                    panel_dsp_format: 'MMMM DD, YYYY ~ HH:mm',
                    marker_dsp_format: 'MMMM Do YYYY, HH:mm:ss',
                    tz_offset: new Date().getTimezoneOffset(), // in minutes from UTC,
                }

                return {

                    timeConverter: function(datestring, marker) {

                        offset = marker ? config.tz_offset *(-1) : config.tz_offset;
                        dsp = marker ? config.marker_dsp_format : config.panel_dsp_format;

                        return momentjs(datestring, marker ? false : dsp).add('minutes', offset).format(dsp);

                    }
                }
            })(moment);

            /* visualization interface */
            var MotionizeMap = (function($){

                //private globals
                var map = new google.maps.Map(document.getElementById("mapbg"), {
                    center: new google.maps.LatLng(32.0700, 34.8400),
                    zoom: 13,
                    // scrollwheel: false, // zooming with mouse
                    mapTypeId: 'roadmap',
                    panControl: true,
                    minZoom: 3,
                    panControlOptions: {
                        position: google.maps.ControlPosition.TOP_RIGHT
                        },
                    zoomControl: true,
                    zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.LARGE,
                        position: google.maps.ControlPosition.TOP_RIGHT
                        }
                });

                var clustererStyles = {
                    minimumClusterSize: 3,
                    maxZoom: 13,
                    styles: [
                        {
                            textColor: '#FFFFFF',
                            fontFamily: '"Open Sans", sans-serif',
                            url: '/images/map/motionize-cluster-small.png',
                            height: 32,
                            width: 32,
                            anchorText: [-5, 0]
                        },
                        {
                            textColor: '#FFFFFF',
                            fontFamily: '"Open Sans", sans-serif',
                            url: '/images/map/motionize-cluster-medium.png',
                            height: 42,
                            width: 42,
                            anchorText: [-6, 0]
                        },
                        {   textColor: '#FFFFFF',
                            fontFamily: '"Open Sans", sans-serif',
                            url: '/images/map/motionize-cluster-large.png',
                            height: 50,
                            width: 50,
                            anchorText: [-8, 0]
                        }
                    ]

                };

                return {

                    config: {
                        v: '1.0',
                        callback: '?',
                        limit_fallback: 1000,
                        limiter_id_legend: 'limit-span', // slider: current value storage
                        limiter_id_input: 'limit'
                    },


                    init: function(ext_config){

                        $.extend(this.config, ext_config);
                        this.initMap();
                        this.initRequiredControls();
                        MotionizeSocket.initSocket(this.config.token);

                    },


                    initMap: function() {

                        $.extend(this, {

                            mapcontroller: {

                                markerClusterer: new MarkerClusterer(map, [], clustererStyles),
                                infoWindow: new google.maps.InfoWindow(),

                                markers: new Array(),
                                markerMixin: {
                                    animation: google.maps.Animation.DROP
                                },

                                accuracy: new Array(),
                                accuracyInput: '#accuracy',
                                accuracyMixin: {

                                    strokeColor: '#42ADE0',
                                    strokeOpacity: 0.8,
                                    strokeWeight: 0.5,
                                    fillColor: '#7EE2F9',
                                    fillOpacity: 0.25

                                },
                                countedmatches: '#countedmatches',

                                matching_entities: 0,
                                currently_shown: 0

                            }
                        });
                    },


                    removeMarkers: function() {

                        for (var marker in this.mapcontroller.markers) {

                            // flush them, not hide
                            this.mapcontroller.markers[marker].setMap(null);
                            this.mapcontroller.accuracy[marker].setMap(null);

                        }

                        //this.mapcontroller.markers = new Array();
                        //this.mapcontroller.accuracy = new Array();
                        this.mapcontroller.markers.length = this.mapcontroller.accuracy.length = 0;
                        this.mapcontroller.markerClusterer.clearMarkers();

                        this.updateCounters("Querying...");
                    },


                    addMarkers: function(markers) {

                        // for (var i=0; i < markers.length; i++) {
                        for (var i in markers) {

                            // filter out zero-locations
                            if (markers[i].lat && markers[i].lon) {

                                var speed = markers[i].res == 'DrivingLoc' ? ' | Speed '+ markers[i].spd +' m/sec' : '';
                                var latLng = new google.maps.LatLng(markers[i].lat, markers[i].lon);
                                var marker = new google.maps.Marker(

                                    $.extend({
                                        position: latLng,
                                        speed: speed,
                                        markerData: markers[i],
                                        title: "(" + markers[i].cmp
                                                + ') User \''+ markers[i].usr
                                                + '\' was ' + markers[i].mvs.toLowerCase() +' here at '
                                                + Utils.timeConverter(markers[i].ts, true)
                                                + speed + ' | Accuracy of '+ markers[i].acc +' meters.',
                                        icon: '../images/map/motionize-marker-'+ markers[i].res.toLowerCase() +'.png'
                                    },
                                    this.mapcontroller.markerMixin)

                                );
                                var markerAccuracy = new google.maps.Circle(

                                    $.extend({
                                        center: latLng,
                                        radius: markers[i].acc
                                    },
                                    this.mapcontroller.accuracyMixin)

                                );
                                this.mapcontroller.markers.push(marker);
                                this.mapcontroller.accuracy.push(markerAccuracy);

                                marker.setMap(map);
                                this.MarkerAccuracyVisibility();

                                var infoWindow = this.mapcontroller.infoWindow;
                                google.maps.event.addListener(marker, 'click', function() {

                                    infoWindow.setContent('<div id="content">'+
                                                              '<div id="siteNotice"></div>'+
                                                              '<h4 style="font-size: 16px;"><b>'+ this.markerData.usr +'</b> from <b>'+ this.markerData.cmp.toUpperCase() +'</b></h4>'+
                                                              '<div id="bodyContent">'+
                                                                  '<p>' +
                                                                      'Seen <b>'+ this.markerData.mvs +'</b> here at <b>'+ Utils.timeConverter(this.markerData.ts, true) +'</b>.'+
                                                                  '</p>'+
                                                                  '<p>Reason for report was <b>'+ this.markerData.res +'</b>'+ this.speed +'<br />'+
                                                                      '<em>This location report\'s accuracy is <b>'+ this.markerData.acc +'</b> meters.</em>' +
                                                                  '</p>'+
                                                              '</div>'+
                                                          '</div>');

                                    infoWindow.open(map, this);

                                });

                            }else console.log("No Location data. Filtered.")

                        }

                        // if markers, center viewport on them
                        if ( this.mapcontroller.markers.length ) {

                            this.mapcontroller.markerClusterer.addMarkers(this.mapcontroller.markers);
                            this.AutoCenterMarkers();

                        }

                    },


                    receiveMarkers: function(responseobject) {
                        /* abstraction and control layer */

                        //alert(JSON.stringify(responseobject)); //show current response packet
                        this.updateCounters(responseobject.length);
                        this.addMarkers(responseobject);

                    },


                    MarkerAccuracyVisibility: function(e) {
                        /* if accuracy toggle is on, show circle behind marker. Otherwise, hide. Default: on .*/

                        var bool = $(this.mapcontroller.accuracyInput).is(':checked');

                        for (var i = 0; i < this.mapcontroller.accuracy.length; i++)
                            this.mapcontroller.accuracy[i].setMap(bool ? map : null);

                    },


                    AutoCenterMarkers: function() {

                        //  Create a new viewpoint bound
                        var bounds = new google.maps.LatLngBounds();

                        //  Loop over current marker array
                        $.each(this.mapcontroller.markers, function (index, marker) { bounds.extend(marker.position) });

                        //  Fit these bounds to the map
                        map.fitBounds(bounds);

                    },


                    updateCounters: function(current_batch) {

                        if (typeof current_batch == "number") {

                            this.mapcontroller.currently_shown += current_batch;
                            $(this.mapcontroller.countedmatches).text(this.mapcontroller.currently_shown +' / '+ this.mapcontroller.matching_entities);

                        }else {
                            this.mapcontroller.currently_shown = this.mapcontroller.matching_entities = 0;
                            $(this.mapcontroller.countedmatches).text((typeof current_batch == "string") ? current_batch : "No matches");
                        }

                    },


                    initRequiredControls: function() {

//                          not getting picked by slider plugin when declared this way
//                        $('<input>', {
//                            'id': this.config.limiter_id_input,
//                            'name': this.config.limiter_id_input,
//                            'type': 'text',
//                            'class': 'form-control input-md',
//                            'data-slider': "true",
//                            'data-slider-values': "300,600,1050,1650,2100,4200",
//                            'data-slider-snap': "true",
//                            'data-slider-equal-steps': "true",
//                            'data-slider-highlight': "true",
//                            'value': 1050
//                        }).appendTo($('#limit-range'));
//                        $("#"+this.config.limiter_id_input).simpleSlider();
                        $( '<span>', { id: this.config.limiter_id_legend })
                                .html(
                                        $( "#"+this.config.limiter_id_input ).val()
                                ).appendTo('.limit-wrapper');


                        $( "#"+this.config.limiter_id_input )
                                .on("slider:changed", function (event, data) {
                                    document.getElementById(MotionizeMap.config.limiter_id_legend).innerHTML = data.value;
                                });
                    }

                }

            })(jQuery);

            /* communication layer */
            var MotionizeSocket = {


                initSocket: function(token) {

                    this.token = token;
                    var channel = new goog.appengine.Channel(this.token);
                    var socket = channel.open();
                    var self = this;

                    socket.onopen = function() {

                        var datadict = {
                            'limit': +document.getElementById(MotionizeMap.config.limiter_id_legend).innerText || MotionizeMap.config.limit_fallback,
                        };

                        if (document.getElementById('companyname'))
                            datadict.companyname = document.getElementById('companyname').value;

                        self.initiateCommunication(datadict);
                    }

                    socket.onmessage = this.newMessage;
                    socket.onerror = function(){ /* alert("Communication error") */ };
                    socket.onclose = function(){ /* alert("Connection closed by remote server") */ };

                },


                initiateCommunication: function(path, datadict) {
                    /*
                     * Sends serialized object by GET or POST to a path via XmlHttpRequest (async)
                     * GET or POST method is expected to be provided in dictionary.
                     * If path is different from current, you have to provide it (not as part of datadict)
                     */
                    if ( !this.initiateCommunication.arguments.length || this.initiateCommunication.arguments.length > 2) {
                        alert('Incorrect arguments.');
                        return;
                    }

                    else if ( this.initiateCommunication.arguments.length == 1 ) {
                        datadict = path;
                        path = window.location.href;
                    }

                    var xhr = new XMLHttpRequest();
                    var method = datadict.hasOwnProperty('method') && datadict.method.toUpperCase() || 'POST';
                    delete datadict.method;

                    var urlEncodedData = this.serializeObject(datadict);

                    // querystring already present
                    if ( method == 'GET' ) {
                        var questionmark = new RegExp("\\?");
                        path.concat((questionmark.test(path) ? "&" : "?") + urlEncodedData);
                    }

                    xhr.open(method, path);
                    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.setRequestHeader('X-Channel-ID', this.token);
                    xhr.send(method == 'POST' && urlEncodedData || null);

                },


                sendForm: function(form) {
                    /* Default behavior for submitting the form data to the server */

                    var formdata = new FormData(form);
                    formdata.append('timestampFrom', Utils.timeConverter(document.getElementById('datetimepicker_from_input').value));
                    formdata.append('timestampTo', Utils.timeConverter(document.getElementById('datetimepicker_to_input').value));
                    if (document.getElementById('companyname')) formdata.append('companyname', document.getElementById('companyname').value);


                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', window.location.href, true);
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.setRequestHeader('X-Channel-ID', this.token);
                    xhr.send(formdata);

                },


                newMessage: function(event) {

                    var response = JSON.parse(event.data);

                    if ( response.hasOwnProperty('messages') ) {

                        if ( response.messages.hasOwnProperty('matching_entities') ) {// only once

                            MotionizeMap.mapcontroller.matching_entities = response.messages.matching_entities;

                            if ( +response.messages.matching_entities === 0 ) { MotionizeMap.updateCounters(); }

                        }
                        // filter debug info
                        console.log(JSON.stringify(response.messages));

                    }

                    if ( response.hasOwnProperty('map_data') && response.map_data.length ) MotionizeMap.receiveMarkers(response.map_data);

                },


                serializeObject: function(dictionary) {

                    var pairs = [];
                    for (var prop in dictionary) {

                        // metadata -> ignore
                        if ( !dictionary.hasOwnProperty(prop) ) {
                            continue;
                        }

                        // nested object -> recursion
                        if (Object.prototype.toString.call(dictionary[prop]) === '[object Object]') {

                            pairs.push( this.serializeObject(dictionary[prop]) );
                            continue;

                        }
                        pairs.push(prop + '=' + encodeURIComponent(dictionary[prop]));
                    }

                    return pairs.join('&');

                }


            }
            document.addEventListener("DOMContentLoaded", function() {

                var timeformat = "MMMM/DD/YYYY HH:mm"
                $('#datetimepicker_from').datetimepicker();

                // moment.js translates timeformat of current date into "February 21, 2014 ~ 13:52"
                $('#datetimepicker_from').data("DateTimePicker").setDate(moment(Date()).subtract('days',1).format(timeformat));
                $('#datetimepicker_to').datetimepicker();
                $('#datetimepicker_to').data("DateTimePicker").setDate(moment(Date()).format(timeformat));

                // map init
                MotionizeMap.init({ token: 'AHRlWrpkLb8g1StYdI3ZR-Uk5xn_WK4mRe-OyGUjwaA005tKKAezqCMPKwjeotreBQ3pm7o0XV1SWR-w-5Ci0J_kJ6eaSeOlbO2ydoFnDhTbnYzFNntxFz8' });


                // communication --- stateless ---
                var form_submit = document.getElementById('submit');
                form_submit.addEventListener("click", function(event) {
                    MotionizeMap.removeMarkers();
                    MotionizeSocket.sendForm(document.forms.namedItem('MotionizeMapForm'));
                    event.preventDefault();
                    return false;

                }, true);

                if ('') console.log('');

                /* ON CHANGE triggers */
                    // datetimepickers
                    $('#datetimepicker_from').on('change.dp',function (e) { $('#datetimepicker_to').data('DateTimePicker').setStartDate(e.date) });
                    $('#datetimepicker_to').on('change.dp',function (e) { $('#datetimepicker_from').data('DateTimePicker').setEndDate(e.date) });

                    // checkboxes
                    var checkboxes = $('input[name^=eventtype]').filter(function() { return this.id.match(/\d/);});
                    checkboxes.on('change', function() {
                        $('#eventtype-all').removeAttr('checked').checked=false;
                    });
                    $('#eventtype-all').on('change', function() {
                        $.map(checkboxes, function(elem) {
                            $(elem).removeAttr('checked').checked=false;
                        });
                    });

                    $('#accuracy').on('change', function(e){ MotionizeMap.MarkerAccuracyVisibility(e) });
                /* END ON CHANGE triggers */

            });
        </script>
    </body>
</html>
